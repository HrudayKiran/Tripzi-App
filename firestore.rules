rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ==================== HELPER FUNCTIONS ====================

    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function isAgeVerified() {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.ageVerified == true;
    }

    function isChatParticipant(chatId) {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/chats/$(chatId)) &&
        request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
    }

    function isChatAdmin(chatId) {
      return isChatParticipant(chatId) && (
        resource.data.createdBy == request.auth.uid ||
        (
          resource.data.admins is list &&
          request.auth.uid in resource.data.admins
        )
      );
    }

    function isChatImmutableFieldsUnchanged() {
      return request.resource.data.createdBy == resource.data.createdBy &&
        request.resource.data.type == resource.data.type &&
        request.resource.data.tripId == resource.data.tripId;
    }

    function isChatMembershipFieldsUnchanged() {
      return request.resource.data.participants == resource.data.participants &&
        request.resource.data.admins == resource.data.admins &&
        request.resource.data.participantDetails == resource.data.participantDetails &&
        request.resource.data.groupName == resource.data.groupName &&
        request.resource.data.groupIcon == resource.data.groupIcon;
    }

    function isMessageImmutableFieldsUnchanged() {
      return request.resource.data.senderId == resource.data.senderId &&
        request.resource.data.createdAt == resource.data.createdAt &&
        request.resource.data.type == resource.data.type;
    }

    function isMessageParticipantStateUpdate() {
      return isMessageImmutableFieldsUnchanged() &&
        request.resource.data.text == resource.data.text &&
        request.resource.data.mediaUrl == resource.data.mediaUrl &&
        request.resource.data.replyTo == resource.data.replyTo &&
        request.resource.data.location == resource.data.location &&
        request.resource.data.voiceDuration == resource.data.voiceDuration &&
        request.resource.data.deletedForEveryoneAt == resource.data.deletedForEveryoneAt &&
        request.resource.data.mentions == resource.data.mentions;
    }

    function isParticipantsOnlyTripUpdate() {
      return request.resource.data.diff(resource.data).affectedKeys()
        .hasOnly(['participants', 'currentTravelers']);
    }

    function isSelfTripJoin() {
      return resource.data.participants is list &&
        request.resource.data.participants is list &&
        request.resource.data.currentTravelers is int &&
        resource.data.currentTravelers is int &&
        !(
          request.auth.uid in resource.data.participants
        ) &&
        request.auth.uid in request.resource.data.participants &&
        request.resource.data.participants.hasAll(resource.data.participants) &&
        request.resource.data.participants.size() == resource.data.participants.size() + 1 &&
        request.resource.data.currentTravelers == resource.data.currentTravelers + 1;
    }

    function isSelfTripLeave() {
      return resource.data.participants is list &&
        request.resource.data.participants is list &&
        request.resource.data.currentTravelers is int &&
        resource.data.currentTravelers is int &&
        request.auth.uid in resource.data.participants &&
        !(
          request.auth.uid in request.resource.data.participants
        ) &&
        resource.data.participants.hasAll(request.resource.data.participants) &&
        request.resource.data.participants.size() == resource.data.participants.size() - 1 &&
        request.resource.data.currentTravelers == resource.data.currentTravelers - 1;
    }

    function isSelfTripJoinLeave() {
      return isParticipantsOnlyTripUpdate() &&
        (isSelfTripJoin() || isSelfTripLeave());
    }

    // ==================== USERS ====================

    match /users/{userId} {
      // Private user profile (owner-only read/write; sensitive fields live here).
      allow read: if isOwner(userId);

      allow create: if isOwner(userId) &&
        request.resource.data.userId == request.auth.uid &&
        (!('ageVerified' in request.resource.data) || request.resource.data.ageVerified == false) &&
        !('ageVerifiedAt' in request.resource.data) &&
        !('dateOfBirth' in request.resource.data) &&
        !('role' in request.resource.data) &&
        !('kyc' in request.resource.data) &&
        !('kycStatus' in request.resource.data);

      allow update: if isOwner(userId) &&
        !request.resource.data.diff(resource.data).affectedKeys().hasAny([
          'role',
          'userId',
          'ageVerified',
          'ageVerifiedAt',
          'dateOfBirth',
          'kyc',
          'kycStatus',
          'rating',
          'emailVerified',
          'phoneVerified'
        ]);

      allow delete: if false;
    }

    // Public user profile mirror for app-wide discovery/search/view.
    // Synced by backend trigger from users/{userId}.
    match /public_users/{userId} {
      allow read: if isAuthenticated();
      allow write: if false;
    }

    // ==================== APP CONFIG ====================

    match /app_config/{docId} {
      allow read: if true;
      allow write: if false;
    }

    match /config/{docId} {
      allow read: if true;
      allow write: if false;
    }

    // ==================== TRIPS ====================

    match /trips/{tripId} {
      allow read: if isAuthenticated();

      allow create: if isAgeVerified() &&
        request.resource.data.userId == request.auth.uid;

      allow update: if isAuthenticated() && (
        (resource.data.userId == request.auth.uid &&
          request.resource.data.userId == resource.data.userId) ||
        isSelfTripJoinLeave()
      );

      allow delete: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;
    }

    // ==================== CHATS ====================

    match /chats/{chatId} {
      allow read: if isChatParticipant(chatId);
      allow create: if isAuthenticated() &&
        request.auth.uid in request.resource.data.participants;

      allow update: if isAuthenticated() && (
        (
          isChatParticipant(chatId) &&
          isChatImmutableFieldsUnchanged() &&
          isChatMembershipFieldsUnchanged()
        ) ||
        (
          isChatAdmin(chatId) &&
          isChatImmutableFieldsUnchanged() &&
          request.resource.data.participants == resource.data.participants &&
          request.resource.data.admins == resource.data.admins &&
          request.resource.data.participantDetails == resource.data.participantDetails &&
          request.resource.data.unreadCount == resource.data.unreadCount &&
          request.resource.data.diff(resource.data).affectedKeys().hasOnly([
            'groupName',
            'groupIcon',
            'updatedAt'
          ])
        )
      );

      // Only the original creator can delete a chat document.
      allow delete: if isAuthenticated() &&
        resource.data.createdBy == request.auth.uid;

      match /messages/{messageId} {
        allow read: if isChatParticipant(chatId);
        allow create: if isChatParticipant(chatId) &&
          request.resource.data.senderId == request.auth.uid;

        allow update: if isAuthenticated() && (
          (
            isChatParticipant(chatId) &&
            resource.data.senderId == request.auth.uid &&
            isMessageImmutableFieldsUnchanged()
          ) ||
          (
            isChatParticipant(chatId) &&
            isMessageParticipantStateUpdate()
          )
        );

        allow delete: if isAuthenticated() &&
          resource.data.senderId == request.auth.uid;
      }

      match /live_shares/{shareId} {
        allow read, write: if isChatParticipant(chatId);
      }
    }

    // ==================== NOTIFICATIONS ====================

    match /notifications/{userId} {
      allow read: if isOwner(userId);
      allow write: if false;

      match /items/{notificationId} {
        allow read: if isOwner(userId);
        allow create: if false;
        allow update, delete: if isOwner(userId);
      }
    }

    // ==================== RATINGS ====================

    match /ratings/{ratingId} {
      allow read: if isAuthenticated();

      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid &&
        request.auth.uid in get(/databases/$(database)/documents/trips/$(request.resource.data.tripId)).data.participants;

      allow update, delete: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;
    }

    // ==================== TOKENS ====================

    match /push_tokens/{userId} {
      allow read, write: if isOwner(userId);
    }

    // ==================== REPORTS ====================

    match /reports/{reportId} {
      allow create: if isAuthenticated() &&
        request.resource.data.reporterId == request.auth.uid;
      allow read: if isAuthenticated() &&
        resource.data.reporterId == request.auth.uid;
      allow update: if false;
      allow delete: if isAuthenticated() &&
        resource.data.reporterId == request.auth.uid;
    }

    // ==================== FEEDBACK ====================

    match /suggestions/{suggestionId} {
      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid;
      allow read, update, delete: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;
    }

    match /bugs/{bugId} {
      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid;
      allow read, update, delete: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;
    }

    match /feature_requests/{requestId} {
      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid;
      allow read, update, delete: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;
    }
  }
}
